---
title: "Untitled"
author: "Ania"
date: "15/02/2022"
output: html_document
---

#1. Loading packages:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(dplyr)
library(stringr)
library(tidyverse)
library(ggplot2)
library(hrbrthemes) # for heatmaps
library(magrittr)
library(pheatmap)
library(MixGHD) # hierarchical clustering which i will finally not use
library(viridis)
library(ggpubr)

```

#2.Functions---FIX IT! think about it bc it's getting complicated!
```{r}

DE_Genevestigator <- function(data, AMP_data, PRO_data, AMP = 2, PRO = 10){
  
  compounds_to_be_stored <- c()
  
  for (i in 1:nrow(data)) {
    if ((max(data[i,AMP_data]) >= AMP) & (max(data[i,PRO_data]) < PRO)) {
      
      compounds_to_be_stored[i] <- data[i,2]
      
    }
  }
  compounds_to_be_stored <- compounds_to_be_stored[!is.na(compounds_to_be_stored)]
  compounds_to_be_stored <- compounds_to_be_stored[!duplicated(compounds_to_be_stored)]
  
  return(data[data$Original %in% compounds_to_be_stored,])
}
```

```{r}
finding_selected_compounds <-function(results_data){
  selected_words <- c()
  for (i in 1:length(results_data$Original)){
    selected_words[i] <- str_extract(results_data$Original[i], "([^\\s]+)") } # extract the first word = compound
    return(unique(selected_words))
}

```

````{r}
calculating_ratios <- function(results_data, AMP, PRO){
  ratio_values <- c() 
  
for (i in 1:nrow(results_data)){
  ratio_values[i] <- exp(sum(results_data[i,AMP],na.rm = TRUE)/length(AMP))/exp(sum(results_data[i,PRO],na.rm = TRUE)/length(PRO))
 }
  return(ratio_values)
}

```



#3. Loading and processing datasets
Here the goal is to make each platform useful for the downstream analysis.

U133A_2 platform:
```{r}
U133A_2 <- read_excel("/Users/Ania/Desktop/Szkoła/ENS /2nd_year/Stage/Practical/Genevestigator/Data/Toxicology-HS_AFFY_U133A-2.xlsx")

U133A_2 <-U133A_2[,-c(2:5)] # removing empty/not needed columns
colnames(U133A_2) <- c("Perturbations", "log2:BM2", "FC:BM2","p-value:BM2",
                       "log2:DEFB1", "FC:DEFB1","p-value:DEFB1",
                       "log2:DEFB4A", "FC:DEFB4A","p-value:DEFB4A",
                       "log2:CAMP", "FC:CAMP","p-value:CAMP",
                       "log2:REG3A", "FC:REG3A","p-value:REG3A",
                       "log2:PLA2G2A", "FC:PLA2G2A","p-value:PLA2G2A",
                       "log2:IL1B", "FC:IL1B","p-value:IL1B",
                       "log2:CXCL8", "FC:CXCL8","p-value:CXCL8",
                       "log2:TNF", "FC:TNF","p-value:TNF" ) # naming columns
U133A_2 <- U133A_2[5:nrow(U133A_2),] # removing empty/not needed rows

# turn all character columns into numeric 
class(U133A_2)
U133A_2_modified <-data.frame(lapply(U133A_2,as.numeric))
U133A_2_modified$Perturbations <- U133A_2$Perturbations
str(U133A_2_modified)
dim(U133A_2_modified)

Pert_names_before_U133 <-U133A_2_modified$Perturbations #keep pertubrations column, keep names only!

Pert_names_after_U133<-c()
for (i in 1:length(Pert_names_before_U133)) {
  Pert_names_after_U133[i] <- str_extract(Pert_names_before_U133[i], "([^\\s]+)") 
}

U133A_2_modified <-U133A_2_modified[ , grepl( "FC." , names(U133A_2_modified) ) ]

U133A_2_modified <-cbind(as.data.frame(Pert_names_after_U133),as.data.frame(Pert_names_before_U133), U133A_2_modified)

colnames(U133A_2_modified) <- c("Compounds", "Original","BM2", "DEFB1","DEFB4A", "CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF")

```

U133PLUS_2_0 platform:
```{r}
#modifying the table for analysis 
U133PLUS_2_0 <- read_excel("/Users/Ania/Desktop/Szkoła/ENS /2nd_year/Stage/Practical/Genevestigator/Data/Toxicology-HS_AFFY_U133PLUS_2-0.xlsx")

U133PLUS_2_0 <-U133PLUS_2_0[,-c(1,3,4,5)]
colnames(U133PLUS_2_0) <- c("Perturbations", "log2:BM2", "FC:BM2","p-value:BM2",
                       "log2:DEFB1", "FC:DEFB1","p-value:DEFB1",
                       "log2:DEFB4A", "FC:DEFB4A","p-value:DEFB4A",
                       "log2:DEFB103B", "FC:DEFB103B","p-value:DEFB103B",
                       "log2:DEFB104A", "FC:DEFB104A","p-value:DEFB104A",
                       "log2:CAMP", "FC:CAMP","p-value:CAMP",
                       "log2:REG3A", "FC:REG3A","p-value:REG3A",
                       "log2:PLA2G2A", "FC:PLA2G2A","p-value:PLA2G2A",
                       "log2:IL1B", "FC:IL1B","p-value:IL1B",
                       "log2:CXCL8", "FC:CXCL8","p-value:CXCL8",
                       "log2:TNF", "FC:TNF","p-value:TNF" )
#not all genes were found on this platform!
U133PLUS_2_0 <- U133PLUS_2_0[5:nrow(U133PLUS_2_0),]
class(U133PLUS_2_0)
str(U133PLUS_2_0)
U133PLUS_2_0_modified <-data.frame(lapply(U133PLUS_2_0,as.numeric))
U133PLUS_2_0_modified$Perturbations <- U133PLUS_2_0$Perturbations
str(U133A_2_modified)
dim(U133PLUS_2_0_modified)

Pert_names_before_U133PLUS <-U133PLUS_2_0_modified$Perturbations #keep pertubrations column, keep names only!

Pert_names_after_U133PLUS<-c()
for (i in 1:length(Pert_names_before_U133PLUS)) {
  Pert_names_after_U133PLUS[i] <- str_extract(Pert_names_before_U133PLUS[i], "([^\\s]+)") 
}

U133PLUS_2_0_modified <-U133PLUS_2_0_modified[ , grepl( "FC." , names(U133PLUS_2_0_modified) ) ]

U133PLUS_2_0_modified <-cbind(as.data.frame(Pert_names_after_U133PLUS),as.data.frame(Pert_names_before_U133PLUS), U133PLUS_2_0_modified)

colnames(U133PLUS_2_0_modified) <- c("Compounds", "Original","BM2", "DEFB1","DEFB4A","DEFB103B","DEFB104A", "CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF")
```

U219-4 platform:
```{r}
#modifying the table for analysis 
U219_4 <-read_excel("/Users/Ania/Desktop/Szkoła/ENS /2nd_year/Stage/Practical/Genevestigator/Data/Toxicology-HS_AFFY_U219-4.xlsx")

U219_4 <-U219_4[,-c(1,3,4,5)]
colnames(U219_4) <- c("Perturbations", "log2:BM2", "FC:BM2","p-value:BM2",
                            "log2:DEFB1", "FC:DEFB1","p-value:DEFB1",
                            "log2:CAMP", "FC:CAMP","p-value:CAMP",
                            "log2:REG3A", "FC:REG3A","p-value:REG3A",
                            "log2:PLA2G2A", "FC:PLA2G2A","p-value:PLA2G2A",
                            "log2:IL1B", "FC:IL1B","p-value:IL1B",
                            "log2:CXCL8", "FC:CXCL8","p-value:CXCL8",
                            "log2:TNF", "FC:TNF","p-value:TNF" )
#not all genes were found on this platform!
U219_4 <- U219_4[5:nrow(U219_4),]
class(U219_4)
str(U219_4)
U219_4_modified <-data.frame(lapply(U219_4,as.numeric))
U219_4_modified$Perturbations <- U219_4$Perturbations
str(U219_4_modified)
U219_4_modified

Pert_names_before_U219_4 <-U219_4_modified$Perturbations #keep pertubrations column, keep names only!

Pert_names_after_U219_4<-c()
for (i in 1:length(Pert_names_before_U219_4)) {
  Pert_names_after_U219_4[i] <- str_extract(Pert_names_before_U219_4[i], "([^\\s]+)") 
}

U219_4_modified <-U219_4_modified[ , grepl( "FC." , names(U219_4_modified) ) ]

U219_4_modified <-cbind(as.data.frame(Pert_names_after_U219_4),as.data.frame(Pert_names_before_U219_4), U219_4_modified)

colnames(U219_4_modified) <- c("Compounds", "Original","BM2", "DEFB1", "CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF")
```


```{r}
LINC_L1000 <-read_excel("/Users/Ania/Desktop/Szkoła/ENS /2nd_year/Stage/Practical/Genevestigator/Data/Toxicology-HS_LINC_L1000-3.xlsx")

LINC_L1000 <-LINC_L1000[,-c(1,3,4,5)]
colnames(LINC_L1000) <- c("Perturbations", 
                          "log2:BM2", "FC:BM2","p-value:BM2",
                      "log2:DEFB1", "FC:DEFB1","p-value:DEFB1",
                      "log2:DEFB4A", "FC:DEFB4A","p-value:DEFB4A",
                      "log2:CAMP", "FC:CAMP","p-value:CAMP",
                      "log2:REG3A", "FC:REG3A","p-value:REG3A",
                      "log2:PLA2G2A", "FC:PLA2G2A","p-value:PLA2G2A",
                      "log2:IL1B", "FC:IL1B","p-value:IL1B",
                      "log2:CXCL8", "FC:CXCL8","p-value:CXCL8",
                      "log2:TNF", "FC:TNF","p-value:TNF" )
#not all genes were found on this platform!
LINC_L1000 <- LINC_L1000[5:nrow(LINC_L1000),]
class(LINC_L1000)
str(LINC_L1000)
LINC_L1000_modified <-data.frame(lapply(LINC_L1000,as.numeric))
LINC_L1000_modified$Perturbations <- LINC_L1000$Perturbations
str(LINC_L1000_modified)
dim(LINC_L1000_modified)

LINC_modified_perturbations <-LINC_L1000_modified$Perturbations
length(LINC_modified_perturbations) 

LINC_time <- c()
LINC_conc <- c()
LINC_cell <- c()
LINC_compound <- c()

for (i in 1:length(LINC_modified_perturbations)){
  
  linc_perturbations_results <- str_match(as.list(LINC_modified_perturbations[i]), ".+\\((.+)\\;\\s?(.+)\\;\\s?(.+)\\).*\\(.*")
  LINC_time[i] <- linc_perturbations_results[2]
  LINC_conc[i] <- linc_perturbations_results[3]
  LINC_cell[i] <- linc_perturbations_results[4]
  
  LINC_compound[i] <-str_extract(LINC_modified_perturbations[i], "([^\\s]+)") 
  

}

LINC_compound

#before you add  new columns, extract only FC columns
LINC_L1000_modified <-LINC_L1000_modified[, grepl("FC.", names(LINC_L1000_modified))]

LINC_L1000_modified <-cbind(as.data.frame(LINC_compound),as.data.frame(LINC_modified_perturbations),as.data.frame(LINC_time),as.data.frame(LINC_conc),as.data.frame(LINC_cell),LINC_L1000_modified)

colnames(LINC_L1000_modified) <- c("Compounds", "Original","Time","Concentration", "Cell","BM2", "DEFB1","DEFB4A", "CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF")
```


#4. Filtering datasets
-AMP >= 2, PRO <=10
-Each platform has a different completion of the missing genes

U133A platform:
```{r, echo=FALSE}
#genes
AMP_U133A_2 <- c("DEFB1","DEFB4A", "CAMP","REG3A","PLA2G2A")
PRO_U133A_2 <- c("IL1B","IL8","TNF")

results_U133A <- DE_Genevestigator(U133A_2_modified,AMP_data = AMP_U133A_2,PRO_data = PRO_U133A_2)
head(results_U133A)
```

U133PLUS_2_0 platform:
```{r, echo=FALSE}
##genes
AMP_U133PLUS_2_0 <- c("DEFB1","DEFB4A","DEFB103B","DEFB104A", "CAMP","REG3A","PLA2G2A")
PRO_U133PLUS_2_0 <- c("IL1B","IL8","TNF")

results_U133PLUS <- DE_Genevestigator(U133PLUS_2_0_modified,AMP_data = AMP_U133PLUS_2_0,PRO_data = PRO_U133PLUS_2_0)
head(results_U133PLUS)

```

U219_4 platform:
```{r}
#genes
AMP_U219_4 <- c("DEFB1","CAMP","REG3A","PLA2G2A")
PRO_U219_4 <- c("IL1B","IL8","TNF")

results_U219_4 <- DE_Genevestigator(U219_4_modified,AMP_data = AMP_U219_4,PRO_data = PRO_U219_4) # nothing

DE_Genevestigator(U219_4_modified,AMP_data = AMP_U219_4,PRO_data = PRO_U219_4,AMP = 0, PRO = 0) # but works

```

LINC-1000
```{r}
#genes
AMP_LINC_L1000 <- c("DEFB1","DEFB4A","CAMP","REG3A","PLA2G2A")
PRO_LINC_L1000 <- c("IL1B","IL8","TNF")

results_LINC <-DE_Genevestigator(LINC_L1000_modified,AMP_data = AMP_LINC_L1000,PRO_data = PRO_LINC_L1000,AMP = 2, PRO = 10)
nrow(results_LINC)

```

#5. Selecting compound names that match conditions

U133A:
```{r}
finding_selected_compounds(results_U133A)
length(finding_selected_compounds(results_U133A))
```

U133PLUS_2-0
```{r}
finding_selected_compounds(results_U133PLUS)
length(finding_selected_compounds(results_U133PLUS))
```

U219-4:
```{r}
finding_selected_compounds(results_U219_4)
```

LINC-100:
```{r}
finding_selected_compounds(results_LINC)
length(finding_selected_compounds(results_LINC))
```

#6. Heat maps (of filtered genes only)

U133A & U133PLUS_2-0 together:

-Manipulations of each data: (remember, these are filtering results already!)
```{r}
#calculate ratios and choose the representatives with the best values from each compound
#results_U133A

results_U133A
AMP_U133A_2
PRO_U133A_2

U133A_ratio_values <- c() 
for (i in 1:nrow(results_U133A)){
  U133A_ratio_values[i] <- (sum(results_U133A[i,AMP_U133A_2],na.rm = TRUE)/length(AMP_U133A_2))/(sum(results_U133A[i,PRO_U133A_2],na.rm = TRUE)/length(PRO_U133A_2))
}

results_U133A$Ratios <- U133A_ratio_values

results_U133A_highest_ratios <-results_U133A %>%
  arrange(desc(results_U133A$Ratios)) 

results_U133A_highest_ratios <- results_U133A_highest_ratios[!duplicated(results_U133A_highest_ratios$Compounds),]

#results_U133PLUS
results_U133PLUS
AMP_U133PLUS_2_0
PRO_U133PLUS_2_0

U133PLUS_ratio_values <- c() 
for (i in 1:nrow(results_U133PLUS)){
  U133PLUS_ratio_values[i] <- (sum(results_U133PLUS[i,AMP_U133PLUS_2_0],na.rm = TRUE)/length(AMP_U133PLUS_2_0))/(sum(results_U133PLUS[i,PRO_U133PLUS_2_0],na.rm = TRUE)/length(PRO_U133PLUS_2_0))
}

results_U133PLUS$Ratios <- U133PLUS_ratio_values

results_U133PLUS_highest_ratios <-results_U133PLUS %>%
  arrange(desc(results_U133PLUS$Ratios)) 

results_U133PLUS_highest_ratios <- results_U133PLUS_highest_ratios[!duplicated(results_U133PLUS_highest_ratios$Compounds),]
```

-Now combine both tables for hierarchical clustering

```{r}
results_U133A_highest_ratios #nrow: 24
results_U133PLUS_highest_ratios #nrow: 23

U133_U133PLUS_joined <-full_join(results_U133A_highest_ratios,results_U133PLUS_highest_ratios)

which(duplicated(U133_U133PLUS_joined$Compounds)) #valproic acid, first one (index 1) is missing 2 genes so used the one indexed with 37 

U133_U133PLUS_joined <- U133_U133PLUS_joined[2:nrow(U133_U133PLUS_joined),]
```

-Hierarchical clustering:
```{r}
#the format of the table is correct, just remove the perturbations

hier_U133_U133PL <-U133_U133PLUS_joined[,-c(1,2,12)]
rownames(hier_U133_U133PL) <- make.names(U133_U133PLUS_joined[,1], unique = TRUE)

pheatmap(hier_U133_U133PL, clustering_method = "ward.D2", show_colnames = TRUE, show_rownames = TRUE, annotation_legend = FALSE, cluster_cols = FALSE,scale = "row",)

```

-Or if you're not sure: simple heatmap instead:
```{r}

joined_tables_for_visualisation <-gather(data = U133_U133PLUS_joined,key = "Gene", value = "Expression_Ratio", -c(Compounds, Original,Ratios))

joined_tables_for_visualisation$Gene <- factor(joined_tables_for_visualisation$Gene, levels = c("BM2", "DEFB1","DEFB4A","DEFB103B", "DEFB104A", "CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF"))

ggplot(joined_tables_for_visualisation, aes(x = Gene, y = Compounds, fill = Expression_Ratio)) +
  geom_tile() +
  theme_classic() +
  scale_fill_viridis() +
  theme(axis.text.y=element_blank()) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
 #important to mention that Ratio = AMP/PRO and Expression_Ratio = DE

```


-LINC-1000 manipulation separately:
```{r}

results_LINC
AMP_LINC_L1000
PRO_LINC_L1000

LINC_100_ratio_values <- c() 
for (i in 1:nrow(results_LINC)){
  LINC_100_ratio_values[i] <- (exp(sum(results_LINC[i,AMP_LINC_L1000],na.rm = TRUE)/length(AMP_LINC_L1000)))/(exp((sum(results_LINC[i,PRO_LINC_L1000],na.rm = TRUE)/length(PRO_LINC_L1000)))
}

results_LINC$Ratios <- LINC_100_ratio_values

results_LINC_highest_ratios <-results_LINC %>%
  arrange(desc(results_LINC$Ratios)) 

results_LINC_highest_ratios <- results_LINC_highest_ratios[!duplicated(results_LINC_highest_ratios$Compounds),]
```


```{r}
# hierarchical clustering 
Hier_LINC <-results_LINC_highest_ratios[,-c(1,2,3,4,5,15)]
rownames(Hier_LINC) <- make.names(results_LINC_highest_ratios[,1], unique = TRUE)

pheatmap(Hier_LINC, clustering_method = "ward.D2", show_colnames = TRUE, show_rownames = FALSE, annotation_legend = FALSE, scale = "row", cluster_cols = FALSE, main = "LINC-1000 unique only")

```
-Hierarchical clustering all of them

```{r}
results_LINC_highest_ratios
U133_U133PLUS_joined

all_platforms_highest_ratios <- full_join(U133_U133PLUS_joined,results_LINC_highest_ratios[,-c(2:4)])

#hierarchical clustering of the 317 compounds 
all_hierarchical_sorted  <- all_platforms_highest_ratios[,-c(1,2,3,12)]

pheatmap(all_hierarchical_sorted, clustering_method = "ward.D2", show_colnames = TRUE, show_rownames = FALSE, annotation_legend = FALSE, cluster_cols = FALSE,scale = "row",main = "Filtered compounds from all platforms ")
  ## so from all of the compounds, these are the ones that have ratio above 1. 
```

#8. More Ratios

All platforms, filtered compounds only. Unique compounds!

```{r}

all_platforms_highest_ratios

ggplot(all_platforms_highest_ratios, aes(x = Compounds, y = Ratios, colour = dplyr::case_when(Ratios > 1 ~ ">1", Ratios < 1 ~ "<1"))) +
  geom_point() + 
  scale_y_continuous(trans = "log10") +
  theme_classic() +
   theme(axis.text.x=element_blank(),
         axis.ticks.x=element_blank())+
  scale_colour_discrete("Ratio") +
  xlab("Compound")+
  ylab("Ratio (AMP/PRO)")
## now I can say, filter the table to only get values with ratio > 1

```

Ratios quantitatively
```{r} 
# Filter compounds that have ratio above 1, and see how many they are
compounds_with_higher_ratios <-all_platforms_highest_ratios %>%
  filter(Ratios > 1) ## 290 compounds!
```

```{r}
 #hierarchical clustering of the 52 compounds (not the ordered compounds)
higher_ratios_hierarchical  <- compounds_with_higher_ratios[,-c(1,2,12)]

pheatmap(higher_ratios_hierarchical, clustering_method = "ward.D2", show_colnames = TRUE, show_rownames = FALSE, annotation_legend = FALSE, cluster_cols = FALSE,scale = "row",main = "Compounds with ratio above 1")
  ## so from all of the compounds, these are the ones that have ratio above 1. 
```

```{r}
#alternatively what I can do is to get the highest ratios simply and choose the 10-20 first values
sorted_ratios_all_compounds <-all_platforms_highest_ratios %>%
  arrange(desc(Ratios))
dim(sorted_ratios_all_compounds) #312 compounds (compounds from the 3 platforms, without filtering for DE >1 )
table_ratios_save <- sorted_ratios_all_compounds[1:20,c("Original", "Ratios")]
colnames(table_ratios_save) <- c("Condition", "Ratio (AMP/PRO)")

#write_csv(table_ratios_save, file = "/Users/Ania/Desktop/Szkoła/ENS /2nd_year/Stage/Practical/Codes/table_ratios_all_genes.csv")

```

#9. Showing the best compounds for separate platforms, without ratios (from the non-filtered results)

For instance, look at HBD2 and HBD3 (5 top genes)
```{r}
# U133P
  #HBD2
U133A_HBD2 <-results_U133A %>%
  arrange(desc(DEFB4A)) %>%
  head(10) 

U133A_HBD2$Compounds
#"pirinixic","pirinixic","NU-1025","fludrocortisone","tamoxifen"                   "iloprost","monorden","arachidonyltrifluoromethane","tacrolimus"                "thalidomide"

  #LL37
U133A_LL37 <-results_U133A %>%
  arrange(desc(CAMP)) %>%
  head(10) 
U133A_LL37$Compounds
# "SK-MEL-5","SK-MEL-5","fludrocortisone","chlorpropamide","tacrolimus","rofecoxib"       "celecoxib",LM-1685","tamoxifen","pirinixic"  
```

```{r}
# U133PLUS
  #HBD2
U133PLUS_HBD2 <-results_U133PLUS %>%
  arrange(desc(DEFB4A)) %>%
  head(10)
U133PLUS_HBD2$Compounds
#"IL-1b","PMA","sodium","flagellin","benzo[a]pyrene","formaldehyde"

  #HBD3
U133PLUS_HBD3 <-results_U133PLUS %>%
  arrange(desc(DEFB103B)) %>%
  head(10)
U133PLUS_HBD3$Compounds 
# PMA" , "formaldehyde"

#LL37

U133PLUS_LL37 <-results_U133PLUS %>%
  arrange(desc(CAMP)) %>%
  head(10)
U133PLUS_LL37$Compounds 
#"piperonylbutoxid", "catechol"
```

```{r}
#LINC

#HBD2
LINC_HBD2 <-results_LINC %>%
  arrange(desc(DEFB4A)) %>%
  head(10)
LINC_HBD2$Compounds 
# much higher than before! "vemurafenib" "alvocidib"   "GW-843682X"  "PF-477736"   "BX-912""AZD-5438"    "tivozanib"   "celastrol"   "SU-11274"    "OTSSP167"

#CAMP

LINC_LL37 <-results_LINC %>%
  arrange(desc(CAMP)) %>%
  head(10)
LINC_LL37$Compounds 
# much higher than before! "canertinib" "OSI-027"    "ON-01910"   "PHA-793887" "imatinib"   "OSI-930" "iniparib"   "AZD4547"    "AZD-8330"   "OSI-930"   

```


#10. Showing genes for data separately (playing around)

Starting with LINC-1000 as it has such a huge number of compounds. What I do here, I should do it at the beginning for each platform.

Working with Ibrutinib data only
```{r}
ibrutinib <- results_LINC %>%
  filter(Compounds == "ibrutinib")

unique(ibrutinib$Concentration) #"0.04uM" "0.12uM" "0.37uM" "1.11uM" "3.33uM" "10uM" 
unique(ibrutinib$Cell)
head(ibrutinib)
```

Preparing Ibrutinib data for visualisation
```{r}
ibrutinib_gathered <- gather(data = ibrutinib,key = "Gene", value = "Expression_Ratio", -c(Compounds, Time, Concentration,Cell, Original))

ibrutinib_gathered$Gene <- factor(ibrutinib_gathered$Gene, levels = c("BM2", "DEFB1","DEFB4A","CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF"))

ibrutinib_gathered$Concentration <- factor(ibrutinib_gathered$Concentration, levels = c("0.04uM", "0.12uM", "0.37uM", "1.11uM", "3.33uM", "10uM"))

```

There are plenty of conditions in LINC data: Time, concentration, cell type, compound. Ibrutinib time-only 24h, let's see how values change across cell types.

One cell type, but concentrations shown
```{r}
A375 <-ggplot(ibrutinib_gathered[ibrutinib_gathered$Cell == "A375",],mapping = aes(x = Gene, y = Expression_Ratio, fill = Concentration)) +
  geom_bar(stat = "identity",position = "dodge") +
  theme_classic() +
  ylab("Expression Ratio") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
A375

```

```{r}
ibrutinib_gathered %>%
  filter(Gene == "DEFB4A", Cell == "A375") %>%
  ggplot(aes(x = Concentration, y = Expression_Ratio)) +
  geom_point() +
  geom_line(group = 1) +
 theme_classic() +
  ylab("HBD2 Expression Ratio") +
  xlab("Concentration")

```

```{r}
ibrutinib_gathered %>%
  filter(Gene == "TNF", Cell == "A375") %>%
  ggplot(aes(x = Concentration, y = Expression_Ratio)) +
  geom_point() +
  geom_line(group = 1) +
 theme_classic() +
  ylab("TNF Expression Ratio") +
  xlab("Concentration")


```
All of cell types at once, not a good plot
```{r}
ggplot(ibrutinib_gathered[ibrutinib_gathered$Gene == "DEFB4A",],mapping = aes(x = Cell, y = Expression_Ratio, colour =Concentration)) +
 geom_point() +
  geom_line(aes(group = Concentration)) +
theme_classic() +
  ylab("HBD2:Expression Ratio")
```

Same idea but better plot I think: shows differences between cell types
```{r}
ggplot(ibrutinib_gathered[ibrutinib_gathered$Gene == "DEFB4A",],mapping = aes(x = Cell, y = Expression_Ratio)) +
    geom_boxplot(outlier.colour = "white") +
  geom_point(aes(colour = Concentration)) +
  theme_classic() +
  ylab("HBD2 Expression Ratio") +
  xlab("Cell type") +
  coord_flip()

```


Okay now let's try to do some time plots. For that I need a different drug where different times were used. Next drug with the greatest ratio and with different times: JNK-9L

-creating separate data
```{r}
JNK_9L <- LINC_L1000_modified %>%
  filter(Compounds == "JNK-9L")

unique(JNK_9L$Concentration) #"0.04uM" "0.12uM" "0.37uM" "1.11uM" "3.33uM" "10uM" 
unique(JNK_9L$Cell) #[1] "BT20"     "HME1"     "HS578T"   "LNCAP"    "MCF7"     "MCF10A"  "MDAMB231" "SKBR3"    "A375"     "A549"     "HA1E"     "HCC515"  
"HEPG2"    "HT29"     "PC3"
unique(JNK_9L$Time) #"3h"  "24h"
head(JNK_9L)

```

-Preparing JNK-9L data for visualisation
```{r}
JNK_9L_gathered <- gather(data = JNK_9L,key = "Gene", value = "Expression_Ratio", -c(Compounds, Time, Concentration,Cell, Original))

JNK_9L_gathered$Gene <- factor(JNK_9L_gathered$Gene, levels = c("BM2", "DEFB1","DEFB4A","CAMP", "REG3A", "PLA2G2A", "IL1B", "IL8", "TNF"))

JNK_9L_gathered$Concentration <- factor(JNK_9L_gathered$Concentration, levels = c("0.04uM", "0.12uM", "0.37uM", "1.11uM", "3.33uM", "10uM"))

JNK_9L_gathered$Time <- factor(JNK_9L_gathered$Time, levels = c( "3h", "24h"))

head(JNK_9L_gathered)
```

-Expression of HBD2 across different time points (2 only!)
```{r}

JNK_9L_gathered %>%
  filter(Cell == "BT20", Gene == "DEFB4A") %>%
ggplot(aes(x = Time, y = Expression_Ratio)) +
  geom_boxplot() +
  geom_jitter(aes(colour = Concentration)) +
  theme_classic() +
  ylab("HBD2 Expression Ratio") 
  

```

-Expression of TNF across different time points (2 only!)
```{r}

JNK_9L_gathered %>%
  filter(Cell == "BT20", Gene == "TNF") %>%
ggplot(aes(x = Time, y = Expression_Ratio)) +
  geom_boxplot(outlier.colour = "white") +
  geom_jitter(aes(colour = Concentration)) +
  theme_classic() +
  ylab("TNF Expression Ratio") 
  

```


Compare several compounds: One gene: several compounds: highest ratios
```{r}
sorted_ratios_all_compounds 
dim(sorted_ratios_all_compounds) #312 compounds (compounds from the 3 platforms, without filtering for DE >1 )

sorted_ratios_for_visualisation <-sorted_ratios_all_compounds[1:5,c(1,5)]

ggplot(sorted_ratios_for_visualisation, aes(x = Compounds, y = DEFB4A, fill = Compounds)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  ylab("HBD2 Expression Ratio") +
  xlab("Compound")

```

